

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1. Pypsi Shell and Command Tutorial &#8212; pypsi 1.4.1 documentation</title>
    
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.4.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="2. Pypsi Builtin Commands" href="pypsi.commands.html" />
    <link rel="prev" title="Pypsi - Python Pluggable Shell Interface" href="index.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pypsi.commands.html" title="2. Pypsi Builtin Commands"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Pypsi - Python Pluggable Shell Interface"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pypsi 1.4.1 documentation</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1. Pypsi Shell and Command Tutorial</a><ul>
<li><a class="reference internal" href="#command-api">1.1. Command API</a><ul>
<li><a class="reference internal" href="#accepting-arguments">1.1.1. Accepting Arguments</a></li>
<li><a class="reference internal" href="#printing">1.1.2. Printing</a><ul>
<li><a class="reference internal" href="#colors">1.1.2.1. Colors</a></li>
<li><a class="reference internal" href="#errors">1.1.2.2. Errors</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example">1.1.3. Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#shell-api">1.2. Shell API</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Pypsi - Python Pluggable Shell Interface</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="pypsi.commands.html"
                        title="next chapter">2. Pypsi Builtin Commands</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/pypsi.tutorial.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="pypsi-shell-and-command-tutorial">
<h1>1. Pypsi Shell and Command Tutorial<a class="headerlink" href="#pypsi-shell-and-command-tutorial" title="Permalink to this headline">¶</a></h1>
<p>This guide will walk through the API and design of Pypsi commands and plugins.</p>
<div class="section" id="command-api">
<h2>1.1. Command API<a class="headerlink" href="#command-api" title="Permalink to this headline">¶</a></h2>
<p>All Pypsi commands will inherit from the base command class:
<a class="reference internal" href="pypsi.core.html#pypsi.core.Command" title="pypsi.core.Command"><code class="xref py py-class docutils literal"><span class="pre">pypsi.core.Command</span></code></a>. Each command has several attributes that determines
how the command is added to the shell. These are:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">name</span></code> - the command name that the user will type. Commands may contain
letters, numbers, underscores, and dashes.</li>
<li><code class="docutils literal"><span class="pre">brief</span></code> - a short description of what the command does.</li>
<li><code class="docutils literal"><span class="pre">usage</span></code> - the usage message displayed when the user requests help.</li>
<li><code class="docutils literal"><span class="pre">topic</span></code> - the topic ID used to categorize the command. This is useful when
the user lists all available commands. The shell will attempt to categorize
commands under headings. All builtin commands have, by default, their topic
set to <code class="docutils literal"><span class="pre">&quot;shell&quot;</span></code>.</li>
</ul>
</div></blockquote>
<p>To ensure that commands are pluggable, commands should accept all of these
attribtues in their constructor so that a shell may customize the command when
loading. However, this is not a requirement. All builtin commands
accept all of the attribute in their constructor.</p>
<p>The command hook <a class="reference internal" href="pypsi.core.html#pypsi.core.Command.setup" title="pypsi.core.Command.setup"><code class="xref py py-meth docutils literal"><span class="pre">setup()</span></code></a> is called once the command
has been created and added to the shell. The setup hook is where setup and
initialization code will reside. Commands should not hold any configuration or
state information in the command itself. However, use the
shell&#8217;s <code class="xref py py-attr docutils literal"><span class="pre">ctx</span></code> attribute to hold stateful information. Storing
information in the shell&#8217;s context is done for two reasons:</p>
<blockquote>
<div><ul class="simple">
<li>The shell&#8217;s state is stored in a single place. This allows for easy and
uniform serialization and deserialization to enable persistent shell
sessions.</li>
<li>Multiple instances of a shell can contain share the same command instance.</li>
</ul>
</div></blockquote>
<p>When a command is executed by the user, the command&#8217;s
<a class="reference internal" href="pypsi.core.html#pypsi.core.Command.run" title="pypsi.core.Command.run"><code class="xref py py-meth docutils literal"><span class="pre">run()</span></code></a> function is called.</p>
<div class="section" id="accepting-arguments">
<h3>1.1.1. Accepting Arguments<a class="headerlink" href="#accepting-arguments" title="Permalink to this headline">¶</a></h3>
<p>All of Pypsi&#8217;s bultin commands use a wrapped version of Python&#8217;s <a class="reference external" href="http://docs.python.org/3.3/library/argparse.html#module-argparse" title="(in Python v3.4)"><code class="xref py py-mod docutils literal"><span class="pre">argparse</span></code></a>
module for argument parsing. The class <a class="reference internal" href="pypsi.core.html#pypsi.core.PypsiArgParser" title="pypsi.core.PypsiArgParser"><code class="xref py py-class docutils literal"><span class="pre">PypsiArgParser</span></code></a>
wraps <a class="reference external" href="http://docs.python.org/3.3/library/argparse.html#argparse.ArgumentParser" title="(in Python v3.4)"><code class="xref py py-class docutils literal"><span class="pre">ArgumentParser</span></code></a> to change the parser&#8217;s behavior when the
user passes invalid arguments or asks for help. By default, the base
ArgumentParser will exit the entire program, which isn&#8217;t ideal for Pypsi.</p>
<p>The only difference between the Pypsi <a class="reference internal" href="pypsi.core.html#pypsi.core.PypsiArgParser" title="pypsi.core.PypsiArgParser"><code class="xref py py-class docutils literal"><span class="pre">pypsi.core.PypsiArgParser</span></code></a> and
<code class="xref py py-mod docutils literal"><span class="pre">argparse.ArgumentParser</span></code> is that the former will raise a
<a class="reference internal" href="pypsi.core.html#pypsi.core.CommandShortCircuit" title="pypsi.core.CommandShortCircuit"><code class="xref py py-class docutils literal"><span class="pre">pypsi.core.CommandShortCircuit</span></code></a> exception when the arguments aren&#8217;t
valid or the user requests help (via <code class="docutils literal"><span class="pre">-h</span></code> or <code class="docutils literal"><span class="pre">--help</span></code>.)</p>
</div>
<div class="section" id="printing">
<h3>1.1.2. Printing<a class="headerlink" href="#printing" title="Permalink to this headline">¶</a></h3>
<p>Pypsi wraps the <code class="xref py py-meth docutils literal"><span class="pre">print()</span></code> function with its own
<code class="xref py py-meth docutils literal"><span class="pre">pypsi_print()</span></code> function, which handles automatic word
wrapping and smart coloring.</p>
<div class="section" id="colors">
<h4>1.1.2.1. Colors<a class="headerlink" href="#colors" title="Permalink to this headline">¶</a></h4>
<p>Pypsi supplies color constants that can be printed to the screen. Colors will
only print if the output stream is a terminal (ie. the stream&#8217;s <code class="docutils literal"><span class="pre">isatty()</span></code>
returns <code class="xref py py-const docutils literal"><span class="pre">True</span></code>.) This means that commands don&#8217;t need to handle printing
colors and not printing colors, the <code class="xref py py-meth docutils literal"><span class="pre">pypsi_print()</span></code> function
handles it.</p>
<p>Color codes are held in the <a class="reference internal" href="pypsi.ansi.html#pypsi.ansi.AnsiCodes" title="pypsi.ansi.AnsiCodes"><code class="xref py py-const docutils literal"><span class="pre">AnsiCodes</span></code></a> object. Using this
constant is straight forward. In this example, the text &#8220;Hello, World!&#8221; is
printed in red and then in green:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">AnsiCodes</span><span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="s2">&quot;Hello, &quot;</span><span class="p">,</span> <span class="n">AnsiCodes</span><span class="o">.</span><span class="n">green</span><span class="p">,</span> <span class="s2">&quot;World!&quot;</span><span class="p">,</span> <span class="n">AnsiCodes</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It is important to pass in <code class="docutils literal"><span class="pre">sep=''</span></code> when printing colors. Otherwise, the above
statement would add a space around each color, which will be confusing to the
user.</p>
</div>
<div class="section" id="errors">
<h4>1.1.2.2. Errors<a class="headerlink" href="#errors" title="Permalink to this headline">¶</a></h4>
<p>To ensure uniform error messages, the <a class="reference internal" href="pypsi.core.html#pypsi.core.Command.error" title="pypsi.core.Command.error"><code class="xref py py-meth docutils literal"><span class="pre">error()</span></code></a> function
is provided to correctly format error messages. With color enabled, this will
print in red: <code class="docutils literal"><span class="pre">&lt;command_name&gt;:</span> <span class="pre">error:</span> <span class="pre">&lt;error_message&gt;</span></code>.</p>
</div>
</div>
<div class="section" id="example">
<h3>1.1.3. Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>This example is the source code of the
<a class="reference internal" href="pypsi.commands.html#pypsi.commands.echo.EchoCommand" title="pypsi.commands.echo.EchoCommand"><code class="xref py py-class docutils literal"><span class="pre">EchoCommand</span></code></a>, which prints the arguments passed
into it to the screen:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Pypsi imports</span>
<span class="kn">from</span> <span class="nn">pypsi.core</span> <span class="k">import</span> <span class="n">Command</span><span class="p">,</span> <span class="n">PypsiArgParser</span><span class="p">,</span> <span class="n">CommandShortCircuit</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="c1"># Custom usage message</span>
<span class="n">EchoCmdUsage</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(prog)s</span><span class="s2"> [-n] [-h] message&quot;</span>


<span class="k">class</span> <span class="nc">EchoCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Prints text to the screen.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;echo&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="n">brief</span><span class="o">=</span><span class="s1">&#39;print a line of text&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">PypsiArgParser</span><span class="p">(</span>
            <span class="n">prog</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">brief</span><span class="p">,</span>
            <span class="n">usage</span><span class="o">=</span><span class="n">EchoCmdUsage</span>
        <span class="p">)</span>

        <span class="n">subcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Stream&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;message to print&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;MESSAGE&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--nolf&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;don&#39;t print newline character&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">EchoCommand</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">format_help</span><span class="p">(),</span> <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
            <span class="n">brief</span><span class="o">=</span><span class="n">brief</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandShortCircuit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span>

        <span class="n">tail</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">nolf</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">message</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">tail</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
<p>The echo command only accepts a single argument: <code class="docutils literal"><span class="pre">-n|--nolf</span></code>. The command
itself mirrors a simple Python command line application. This means that porting
existing applications to Pypsi commands is extremely easy. Also, notice the
<code class="docutils literal"><span class="pre">try...except...</span></code> around <code class="docutils literal"><span class="pre">parser.parse_args</span></code>. This is catching the
<a class="reference internal" href="pypsi.core.html#pypsi.core.CommandShortCircuit" title="pypsi.core.CommandShortCircuit"><code class="xref py py-class docutils literal"><span class="pre">CommandShortCircuit</span></code></a> exception, which in this case will be
thrown if the user enters any of the following:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">-h</span></code>, <code class="docutils literal"><span class="pre">--help</span></code> - print usage information</li>
<li><code class="docutils literal"><span class="pre">-x</span></code> - an invalid argument for the echo command</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="shell-api">
<h2>1.2. Shell API<a class="headerlink" href="#shell-api" title="Permalink to this headline">¶</a></h2>
<p>Pypsi shells are typically barebones and do not contain much. This is a similar
design to ORM libraries such as Django and MongoEngine, where the database table
(or document) just holds the list of attributes as class variables.</p>
<p>All shells much inherit from the base class <a class="reference internal" href="pypsi.shell.html#pypsi.shell.Shell" title="pypsi.shell.Shell"><code class="xref py py-class docutils literal"><span class="pre">Shell</span></code></a>. Then,
add command instances. In this example, a new shell is created, given the name
&#8220;example&#8221; and the echo command is added, but renamed to <code class="docutils literal"><span class="pre">print</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Pypsi Imports</span>
<span class="kn">from</span> <span class="nn">pypsi.shell</span> <span class="k">import</span> <span class="n">Shell</span>
<span class="kn">from</span> <span class="nn">pypsi.commands.echo</span> <span class="k">import</span> <span class="n">EchoCommand</span>

<span class="k">class</span> <span class="nc">MyShell</span><span class="p">(</span><span class="n">Shell</span><span class="p">):</span>
    <span class="n">echo_cmd</span> <span class="o">=</span> <span class="n">EchoCommand</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;print&#39;</span><span class="p">)</span>

<span class="n">shell</span> <span class="o">=</span> <span class="n">MyShell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;example&#39;</span><span class="p">)</span>
<span class="n">shell</span><span class="o">.</span><span class="n">cmdloop</span><span class="p">()</span>
</pre></div>
</div>
<p>Once running, the user will be presented with a prompt and will be able to use
the <code class="docutils literal"><span class="pre">print</span></code> command (which is the <a class="reference internal" href="pypsi.commands.html#pypsi.commands.echo.EchoCommand" title="pypsi.commands.echo.EchoCommand"><code class="xref py py-class docutils literal"><span class="pre">EchoCommand</span></code></a>.)</p>
<p>Several hooks exist in the shell that can be overriden. These include:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="pypsi.shell.html#pypsi.shell.Shell.on_shell_ready" title="pypsi.shell.Shell.on_shell_ready"><code class="xref py py-meth docutils literal"><span class="pre">on_shell_ready()</span></code></a> - called when the shell is created</li>
<li><a class="reference internal" href="pypsi.shell.html#pypsi.shell.Shell.on_cmdloop_begin" title="pypsi.shell.Shell.on_cmdloop_begin"><code class="xref py py-meth docutils literal"><span class="pre">on_cmdloop_begin()</span></code></a> - called when the
<a class="reference internal" href="pypsi.shell.html#pypsi.shell.Shell.cmdloop" title="pypsi.shell.Shell.cmdloop"><code class="xref py py-meth docutils literal"><span class="pre">cmdloop()</span></code></a> function is called</li>
<li><a class="reference internal" href="pypsi.shell.html#pypsi.shell.Shell.on_cmdloop_end" title="pypsi.shell.Shell.on_cmdloop_end"><code class="xref py py-meth docutils literal"><span class="pre">on_cmdloop_end()</span></code></a> - called when the cmdloop has ended
(usually because the user is exiting the shell)</li>
</ul>
</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pypsi.commands.html" title="2. Pypsi Builtin Commands"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Pypsi - Python Pluggable Shell Interface"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pypsi 1.4.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, Adam Meily.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.5.
    </div>
  </body>
</html>